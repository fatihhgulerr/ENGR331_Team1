<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Ingestible Sensor Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: linear-gradient(to right, #0f2027, #203a43, #2c5364);
      color: #ffffff;
    }

    header {
      text-align: center;
      font-size: 2rem;
      font-weight: 700;
      padding: 30px 20px;
      background: rgba(255,255,255,0.05);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .connect-btn {
      display: block;
      margin: 20px auto;
      background: #80d0c7;
      border: none;
      color: #203a43;
      padding: 10px 20px;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .connect-btn:hover { background: #68b3a5; }
    .connect-btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: flex-start;
      gap: 40px;
      padding: 40px 20px;
    }

    .card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(12px);
      border-radius: 16px;
      padding: 25px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      width: 400px;
      max-width: 90vw;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .card h2 {
      margin-top: 0;
      font-size: 1.3rem;
      color: #80d0c7;
      letter-spacing: 0.5px;
    }

    #phValue, #tempValue {
      font-size: 3rem;
      font-weight: bold;
      animation: pulse 2s infinite;
    }
    #phValue { color: #00ffb3; }
    #tempValue { color: #ff8c00; }

    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.85; }
      100% { transform: scale(1); opacity: 1; }
    }

    #rendererContainer {
      width: 100%;
      min-height: 300px;
      aspect-ratio: 4 / 3;
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    #rotationData {
      font-size: 1.1rem;
      line-height: 1.6;
      color: #ffffff;
    }

    canvas { display: block; }
  </style>
</head>
<body>

  <header>Ingestible Sensor Dashboard</header>
  <button id="connectBtn" class="connect-btn">Connect to Capsule</button>

  <div class="container">
    <div class="card">
      <h2>pH Level (Real-Time)</h2>
      <div id="phValue">--</div>
    </div>

    <div class="card">
      <h2>Temperature (°C)</h2>
      <div id="tempValue">__.__°C</div>
    </div>

    <div class="card">
      <h2>Pill Movement &amp; Orientation</h2>
      <div id="rendererContainer"></div>
      <div id="rotationData">
        <div>Pitch (X): <span id="pitch">0°</span></div>
        <div>Yaw (Y): <span id="yaw">0°</span></div>
        <div>Roll (Z): <span id="roll">0°</span></div>
      </div>
    </div>
  </div>

  <script>
    /* THREE.js scene globals */
    let capsule, camera, renderer, scene;
    const targetRot = { x: 0, y: 0, z: 0 };
    const currentRot = { x: 0, y: 0, z: 0 };
    const targetPos = { x: 0, y: 0, z: 0 };
    const currentPos = { x: 0, y: 0, z: 0 };

    window.onload = () => {
      /* ----------------- 3D VISUAL ----------------- */
      scene   = new THREE.Scene();
      camera  = new THREE.PerspectiveCamera(75, 4 / 3, 0.1, 1000);
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      const container = document.getElementById("rendererContainer");
      container.appendChild(renderer.domElement);

      /* Capsule model */
      const capsuleGeo = new THREE.CylinderGeometry(0.3, 0.3, 1.2, 32);
      const capsuleMat = new THREE.MeshStandardMaterial({ color: "#00c2ff", roughness: 0.4, metalness: 0.5 });
      capsule = new THREE.Mesh(capsuleGeo, capsuleMat);
      capsule.scale.set(1.4, 1.4, 1.4);
      scene.add(capsule);

      /* Lights */
      scene.add(new THREE.PointLight(0xffffff, 1.5, 0, 0).position.set(5, 5, 5));
      scene.add(new THREE.AmbientLight(0x404040));

      /* A simple grid + bounding box for aesthetics */
      scene.add(new THREE.GridHelper(6, 6));
      const edges = new THREE.EdgesGeometry(new THREE.BoxGeometry(4, 4, 4));
      scene.add(new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0xffffff })));

      camera.position.set(0, 0, 8);

      /* ---- Animation ---- */
      function animate() {
        requestAnimationFrame(animate);

        /* Smooth rotation */
        currentRot.x += (targetRot.x - currentRot.x) * 0.1;
        currentRot.y += (targetRot.y - currentRot.y) * 0.1;
        currentRot.z += (targetRot.z - currentRot.z) * 0.1;
        capsule.rotation.set(currentRot.x, currentRot.y, currentRot.z);

        /* Smooth translation */
        currentPos.x += (targetPos.x - currentPos.x) * 0.1;
        currentPos.y += (targetPos.y - currentPos.y) * 0.1;
        currentPos.z += (targetPos.z - currentPos.z) * 0.1;
        capsule.position.set(currentPos.x, currentPos.y, currentPos.z);

        renderer.render(scene, camera);

        /* Rotation HUD */
        document.getElementById("pitch").textContent = (currentRot.x * 180 / Math.PI).toFixed(1) + "°";
        document.getElementById("yaw").textContent   = (currentRot.y * 180 / Math.PI).toFixed(1) + "°";
        document.getElementById("roll").textContent  = (currentRot.z * 180 / Math.PI).toFixed(1) + "°";
      }

      /* Handle resize */
      function resizeRenderer() {
        const width  = container.clientWidth;
        const height = width * 0.75;
        renderer.setSize(width, height);
        camera.aspect = width / height;
        camera.updateProjectionMatrix();
      }
      window.addEventListener('resize', resizeRenderer);
      setTimeout(resizeRenderer, 100);
      animate();

      /* --------------- SERIAL CONNECTION ------------- */
      document.getElementById('connectBtn').addEventListener('click', connectSerial);

      async function connectSerial() {
        /* 0) Feature + HTTPS check */
        if (!('serial' in navigator)) {
          alert('Web Serial API is not supported in this browser.');
          return;
        }
        if (!location.protocol.startsWith('https') && location.hostname !== 'localhost') {
          alert('Web Serial only works over HTTPS or on localhost.');
          return;
        }

        /* 1) Select + open port */
        const port = await navigator.serial.requestPort();
        await port.open({ baudRate: 9600 });

        /* 2) Some USB-Serial bridges need these */
        try { await port.setSignals({ dataTerminalReady: true, requestToSend: true }); } catch (_) { /* ignore */ }

        const btn = document.getElementById('connectBtn');
        btn.textContent = 'Connected';
        btn.disabled = true;

        /* 3) Stream reader */
        const reader = port.readable.getReader();
        let buf = '';

        try {
          while (true) {
            const { value, done } = await reader.read();
            if (done) break; // port closed

            buf += new TextDecoder().decode(value);
            const lines = buf.split(/[\r\n]+/);
            buf = lines.pop(); // keep incomplete

            for (const raw of lines) {
              const line = raw.trim();
              if (!line) continue;

              /* Accept formats like "pH:7.14", "7.14", "7,14" ... */
              const num = parseFloat(line.replace(/[^0-9.,-]/g, '').replace(',', '.'));
              if (!isNaN(num)) {
                document.getElementById('phValue').textContent = num.toFixed(2);
              }
            }
          }
        } catch (err) {
          console.error('Serial error:', err);
        } finally {
          reader.releaseLock();
          await port.close();
          btn.textContent = 'Connect to Capsule';
          btn.disabled = false;
        }
      }
    };
  </script>
</body>
</html>